const { Analysis, Device, Services, Utils } = require("@tago-io/sdk");
const axios = require("axios");
const moment = require("moment-timezone");

// Function to determine recommendations based on ISO values
function getRecommendations(isoValue, thresholds) {
  if (isoValue <= thresholds.green) {
    return "Maintain current filtration system. Regularly monitor to ensure continued effectiveness.";
  } else if (isoValue <= thresholds.orange) {
    return "Consider upgrading to a higher efficiency filtration system to remove finer particles.";
  } else {
    return "Immediate action required. Implement high-efficiency filtration and conduct a system flush to remove existing contamination.";
  }
}

async function myAnalysis(context) {
  try {
    const env_vars = Utils.envToJson(context.environment);

    if (!env_vars.email) {
      return context.log("Email environment variable not found");
    }
    if (!env_vars.device_token) {
      return context.log("Device_token environment variable not found");
    }

    const device = new Device({ token: env_vars.device_token });
    const variables = ["total_bubbles", "fibre", "total_particles", "iso4", "iso6", "iso14", "cutting", "sliding", "fatigue", "air", "unknown"];

    const today_date = moment().tz("Australia/Perth");
    const start_date = moment(today_date).subtract(7, 'days').format("YYYY-MM-DDTHH:mm:ss");
    const end_date = today_date.format("YYYY-MM-DDTHH:mm:ss");
    const full_date = today_date.format("YYYY-MM-DD"); // Format the date as needed

    const data = await device.getData({
      variables,
      start_date,
      end_date,
      qty: 8, // Fetching last 8 readings
    });

    let reportContent = variables.map(variable => {
      const variableData = data.filter(item => item.variable === variable);
      return {
        variable,
        values: variableData.map(d => ({
          value: d.value,
          timestamp: moment(d.timestamp).tz("Australia/Perth").format("YYYY-MM-DD HH:mm:ss")
        }))
      };
    });

    // Prepare chart data with custom series names for colors
    const isoChartData = {
      labels: reportContent.find(item => item.variable === 'iso4').values.map(d => d.timestamp),
      series: [
        reportContent.find(item => item.variable === 'iso4').values.map(d => d.value),
        reportContent.find(item => item.variable === 'iso6').values.map(d => d.value),
        reportContent.find(item => item.variable === 'iso14').values.map(d => d.value)
  ]
};

    // Prepare table data
    const tableVariables = ["fibre", "cutting", "sliding", "fatigue", "air", "unknown"];
    let tableContent = tableVariables.map(variable => {
      return {
        variable,
        values: reportContent.find(item => item.variable === variable).values.map(d => d.value)
      };
    });

    // Define thresholds for each ISO value
    const thresholds = {
      iso4: { green: 10, orange: 20, red: 30 },
      iso6: { green: 15, orange: 25, red: 35 },
      iso14: { green: 20, orange: 30, red: 40 }
    };

    // Function to determine the background color
    function getStatusAndColor(value, thresholds) {
  if (value <= thresholds.green) {
    return { text: 'Good', color: '#00ff00' }; // Green
  } else if (value <= thresholds.orange) {
    return { text: 'Caution', color: '#ffa500' }; // Orange
  } else {
    return { text: 'Critical', color: '#ff0000' }; // Red
  }
}

    // Calculate averages and determine background colors
    const iso4Avg = Math.round(reportContent.find(item => item.variable === 'iso4').values.reduce((acc, val) => acc + val.value, 0) / 8);
    const iso6Avg = Math.round(reportContent.find(item => item.variable === 'iso6').values.reduce((acc, val) => acc + val.value, 0) / 8);
    const iso14Avg = Math.round(reportContent.find(item => item.variable === 'iso14').values.reduce((acc, val) => acc + val.value, 0) / 8);

    const iso4Status = getStatusAndColor(iso4Avg, thresholds.iso4);
    const iso6Status = getStatusAndColor(iso6Avg, thresholds.iso6);
    const iso14Status = getStatusAndColor(iso14Avg, thresholds.iso14);

// Determine recommendations for each ISO value
    const iso4Recommendation = getRecommendations(iso4Avg, thresholds.iso4);
    const iso6Recommendation = getRecommendations(iso6Avg, thresholds.iso6);
    const iso14Recommendation = getRecommendations(iso14Avg, thresholds.iso14);

    // Fetch the external HTML template
    const pdf_template_url = "https://raw.githubusercontent.com/miningandhydraulics/pdf_tool/main/test_pdf.html";
    let html = (await axios.get(pdf_template_url)).data;

    // Replace placeholders in the HTML template with your data
    html = html.replace(/\$\{iso4_avg\}/g, iso4Avg);
    html = html.replace(/\$\{iso6_avg\}/g, iso6Avg);
    html = html.replace(/\$\{iso14_avg\}/g, iso14Avg);
    html = html.replace(/\$\{iso4_color\}/g, iso4Status.color);
    html = html.replace(/\$\{iso6_color\}/g, iso6Status.color);
    html = html.replace(/\$\{iso14_color\}/g, iso14Status.color);
    html = html.replace(/\$\{chart_labels\}/g, JSON.stringify(isoChartData.labels));
    html = html.replace(/\$\{chart_series\}/g, JSON.stringify(isoChartData.series));
    html = html.replace(/\$\{table_content\}/g, generateTableHTML(tableContent));
    html = html.replace(/\$\{full_date\}/g, full_date); // Replace the full_date placeholder
    html = html.replace(/\[Good\/Caution\/Critical for ISO 4\]/g, `<span style="color: ${iso4Status.color};">${iso4Status.text}</span>`);
    html = html.replace(/\[Good\/Caution\/Critical for ISO 6\]/g, `<span style="color: ${iso6Status.color};">${iso6Status.text}</span>`);
    html = html.replace(/\[Good\/Caution\/Critical for ISO 14\]/g, `<span style="color: ${iso14Status.color};">${iso14Status.text}</span>`);
   // Replace the current year placeholder
    html = html.replace(/\$\{current_year\}/g, new Date().getFullYear());
    // Replace ISO value placeholders in the Analysis and Findings section
    html = html.replace(/\$\{iso4_value\}/g, iso4Avg);
    html = html.replace(/\$\{iso6_value\}/g, iso6Avg);
    html = html.replace(/\$\{iso14_value\}/g, iso14Avg);
    html = html.replace('[Specific actions based on ISO 4 value]', iso4Recommendation);
    html = html.replace('[Specific actions based on ISO 6 value]', iso6Recommendation);
    html = html.replace('[Specific actions based on ISO 14 value]', iso14Recommendation);

    // Generate PDF
    const base64 = Buffer.from(html).toString("base64");
    const options = {
      displayHeaderFooter: false,
      margin: {
        top: "0.25cm",
        right: "0.25cm",
        left: "0.25cm",
        bottom: "0.25cm",
      },
    };

    const result = await axios.post("https://pdf.middleware.tago.io", { base64, options }, { headers: { token: context.token } });
    const pdf = result.data.result;

    // Send the email
    const email = new Services({ token: context.token }).email;
    const email_settings = {
      to: env_vars.email,
      subject: "Your Custom Report",
      message: "Here is your custom report.",
      attachment: {
        archive: pdf,
        type: "base64",
        filename: "custom-report.pdf",
      },
    };

    await email.send(email_settings);
    console.log("Email sent with success.");
  } catch (error) {
    console.log(error);
  }
}

// Helper function to generate table HTML
function generateTableHTML(tableData) {
  let tableHTML = '<table><thead><tr><th>Variable</th>';
  for (let i = 1; i <= 8; i++) {
    tableHTML += `<th>Reading ${i}</th>`;
  }
  tableHTML += '</tr></thead><tbody>';
  tableData.forEach(row => {
    tableHTML += `<tr><td>${row.variable}</td>`;
    row.values.forEach(value => {
      tableHTML += `<td>${value}</td>`;
    });
    tableHTML += '</tr>';
  });
  tableHTML += '</tbody></table>';
  return tableHTML;
}

module.exports = new Analysis(myAnalysis);
